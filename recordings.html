<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Delete External Consult Transfers</title>

  <!-- Bootstrap core CSS -->
  <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  <!-- Custom styles for this template -->
  <link href="recordings.css" rel="stylesheet" />
  <link href="./assets/dist/css/bootstrap-datepicker3.standalone.min.css" rel="stylesheet">
</head>

<body class="text-center">
  <div style="margin: 0 auto;">

    <!-- Header -->
    <button class="btn btn-secondary" type="button" onclick="logout()">Logout</button>
    <h3>Delete Consult Transfer Recordings</h3>

    <!-- Messages -->
    <div class="alert alert-info mb-3 mt-3" role="alert">
      Your user needs the following permissions: Recordings > All Permissions and Analytics > All Permissions<br>
      Recordings will not show as deleted immediately. This will take a few minutes.
    </div>
    <div class="alert alert-warning mb-3 mt-3" role="alert">
      WARNING: Once recordings are deleted, they can not be recovered. Make sure you know what you are doing!
    </div>

    <!-- Date Selection -->
    <div class="span5 col-md-5 mb-3" id="sandbox-container" style="margin: 0 auto;">
      <h4>Select a Date range</h4>
      <div class="input-daterange input-group" id="datepicker">
        <input type="text" class="input-sm form-control" name="start" id="start">
        <span class="input-group-addon ml-2 mr-2">to</span>
        <input type="text" class="input-sm form-control" name="end" id="end">
      </div>
      <div>
        <small><strong>Do not exceed 31 days</strong></small><br>
        <button class="btn btn-primary" type="button" onclick="start()" id="search">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="spinner" hidden></span>
          Search
        </button>
      </div>
    </div>

    <!-- Recordings Table -->
    <table class="table table-hover">
      <thead>
        <tr>
          <th scope="col">Start Time</th>
          <th scope="col">Conversation w/ Consult Transfer</th>
          <th scope="col">Recordings</th>
          <th scope="col">Last Recording</th>
        </tr>
      </thead>
      <tbody id="conversationsTable">
      </tbody>
    </table>
  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="./assets/dist/js/bootstrap-datepicker.min.js"></script>

  <script type="text/javascript">

    let results = {};
    let divisions = [];

    let token = localStorage.getItem('access_token');
    let environment = localStorage.getItem('environment');

    //#region Date Range Selection

    Date.prototype.addDays = function (days) {
      var date = new Date(this.valueOf());
      date.setDate(date.getDate() + days);
      return date;
    }
    let endDate = new Date();
    endDate.addDays(1);

    $('#sandbox-container .input-daterange').datepicker({
      format: "yyyy-mm-ddT00:00:00Z",
      endDate: endDate.toISOString().split("T")[0],
      todayBtn: "linked",
      autoclose: true,
      todayHighlight: true
    });

    //#endregion 

    async function start() {
      try {
        $("#search").attr('disabled', true);
        $("#spinner").attr('hidden', false);

        if ($("#start").val() === '' || $("#end").val() === '') {
          alert("Please set the start and end dates first");
          return;
        }

        console.log('start()');

        // Get list of conversations with consult transfers to external parties
        await runAnalyticsQuery();

        // Get recordings ids
        await getRecordingIds();

        // Populate table
        console.log('Results:', results);
        for await (const conversation of results.analyticsQueryResults.conversations) {
          let conversationRow = $("<tr/>").appendTo("#conversationsTable");

          // Start Time
          $("<td/>").text(conversation.conversationStart).appendTo(conversationRow)

          // Conversation - Id
          let conversationTd = $("<td/>").appendTo(conversationRow);
          let conversationDiv = $("<div/>").appendTo(conversationTd);
          $("<div/>").text(conversation.conversationId).appendTo(conversationDiv);

          // Conversation - Division
          let conversationDivisionDiv = $("<div/>").appendTo(conversationDiv);
          for (let index = 0; index < conversation.divisionIds.length; index++) {
            const conversationDivisionId = conversation.divisionIds[index];

            // Cache division name to avoid calling the API every time
            let divisionName;
            let existingDivision = divisions.find(d => d.id === conversationDivisionId);
            if (existingDivision && existingDivision.length > 0) {
              divisionName = existingDivision.name;
            } else {
              let data = await callAPI('GET', `authorization/divisions/${conversationDivisionId}`);
              divisionName = data.name;
              divisions.push({
                id: conversationDivisionId,
                name: data.name
              });
            }
            $("<small/>").text(`Division: ${divisionName}`).appendTo(conversationDivisionDiv);
          }

          // Recordings
          let recordingsTd = $("<td />", {}).appendTo(conversationRow);
          let lastRecording;
          for await (const recording of conversation.recordings) {
            let recordingDiv = $("<div/>").appendTo(recordingsTd);
            $("<div/>").text(recording.id).appendTo(recordingDiv);
            let recordingStartTimeDiv = $("<div/>").appendTo(recordingDiv);
            $("<small/>").text(`Start Time: ${recording.startTime}`).appendTo(recordingStartTimeDiv);

            lastRecording = {
              conversationId: conversation.conversationId,
              recordingId: recording.id,
              fileState: recording.fileState
            };
          }

          // Last Recording
          let lastRecordingTd = $("<td />", {}).appendTo(conversationRow);

          let lastRecordingDiv = $("<div/>").appendTo(lastRecordingTd);
          let buttonClass = lastRecording.fileState !== "AVAILABLE" ? "btn-success" : "btn-danger";
          let buttonText = lastRecording.fileState !== "AVAILABLE" ? `Status: ${lastRecording.fileState}` : "Delete Last Recording";
          let buttonDisabled = lastRecording.fileState !== "AVAILABLE";
          $("<button/>", { class: `btn ml-3 ${buttonClass}`, disabled: buttonDisabled }).text(buttonText).on('click', (e) => deleteRecording(lastRecording.conversationId, lastRecording.recordingId)).appendTo(lastRecordingDiv);

          let lastRecordingRecordingId = $("<div/>").appendTo(lastRecordingDiv);
          $("<small/>", {}).text(` (${lastRecording.recordingId})`).appendTo(lastRecordingRecordingId);
        }
      } catch (err) {
        console.error(err);
      } finally {
        $("#search").attr('disabled', false);
        $("#spinner").attr('hidden', true);
      }
    }

    function runAnalyticsQuery() {
      return new Promise(async (resolve, reject) => {
        try {
          let body = {
            "interval": `${$("#start").val()}/${$("#end").val()}`,
            "order": "asc",
            "orderBy": "conversationStart",
            "paging": {
              "pageSize": 100,
              "pageNumber": 1
            },
            "segmentFilters": [
              {
                "type": "or",
                "predicates": [
                  {
                    "type": "dimension",
                    "dimension": "direction",
                    "operator": "matches",
                    "value": "outbound"
                  }
                ]
              }
            ],
            "conversationFilters": [
              {
                "type": "or",
                "predicates": [
                  {
                    "type": "metric",
                    "metric": "nConsultTransferred",
                    "range": {
                      "gte": 1
                    }
                  }
                ]
              }
            ]
          };

          let data = await callAPI('POST', 'analytics/conversations/details/query', body);
          results.analyticsQueryResults = data;
          return resolve();
        } catch (error) {
          return reject(error)
        }
      });
    }

    function getRecordingIds() {
      return new Promise(async (resolve, reject) => {
        try {
          if (!results.analyticsQueryResults || !results.analyticsQueryResults.conversations) {
            alert('No conversations found');
            return reject('No conversations found');
          }
          for await (const conversation of results.analyticsQueryResults.conversations) {
            let data = await callAPI('GET', `conversations/${conversation.conversationId}/recordings?maxWaitMs=5000&formatId=WEBM`);
            console.debug(data);
            conversation.recordings = data;
          }
          return resolve();
        } catch (error) {
          return reject(error);
        }
      });
    }

    function deleteRecording(conversationId, recordingId) {
      return new Promise(async (resolve, reject) => {
        try {
          let body = {
            fileState: "DELETED",
            deleteDate: "2020-11-01T00:00:00Z" // Old enough to get deleted ASAP
          };

          let data = await callAPI('PUT', `conversations/${conversationId}/recordings/${recordingId}`, body);
          console.log('Recording deleted');
          return resolve();
        } catch (error) {
          return reject(error);
        }
      });
    }

    async function logout() {
      await callAPI('DELETE', 'tokens/me');
      localStorage.clear('access_token');
      localStorage.clear('environment');
      window.location.href = 'index.html';
    }

    function callAPI(method, apiPath, body) {
      console.debug('Calling:', apiPath);

      return new Promise(async (resolve, reject) => {
        try {
          await axios({
            url: `https://api.${environment}/api/v2/${apiPath}`,
            method: method,
            headers: {
              Authorization: `bearer ${token}`,
              'Content-Type': 'application/json',
            },
            data: body
          })
            .then((response) => {
              console.debug('Axios request succeeded:', response);
              return resolve(response.data);
            })
            .catch((error) => {
              return reject(error);
            })
            .finally(() => {
              console.debug('Axios request complete.');
            });
        } catch (error) {
          console.error(error);
          return reject(error);
        } finally {
          console.debug('Request complete.');
        }
      });
    }

  </script>
</body>

</html>