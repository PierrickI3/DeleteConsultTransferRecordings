<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>Delete External Consult Transfers</title>

  <!-- Bootstrap core CSS -->
  <link href="./assets/dist/css/bootstrap.min.css" rel="stylesheet" />

  <style>
    .bd-placeholder-img {
      font-size: 1.125rem;
      text-anchor: middle;
      -webkit-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }

    @media (min-width: 768px) {
      .bd-placeholder-img-lg {
        font-size: 3.5rem;
      }
    }
  </style>
  <!-- Custom styles for this template -->
  <link href="recordings.css" rel="stylesheet" />
  <link href="./assets/dist/css/bootstrap-datepicker3.standalone.min.css" rel="stylesheet">
</head>

<body class="text-center">

  <!-- Main Body -->
  <div style="margin: 0 auto;">

    <!-- Toast -->
    <div aria-live="polite" aria-atomic="true" style="position: fixed; min-height: 200px; z-index: 999999;">
      <!-- Position it -->
      <div style="position: fixed; top: 0; right: 0; z-index: 999999;">

        <!-- Then put toasts within -->
        <div class="toast" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header bg-secondary text-white">
            <strong class="mr-auto">Deleting Recording</strong>
            <small class="text-muted">just now</small>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="toast-body bg-success text-white">
            Your recording will be deleted shortly.
          </div>
        </div>
      </div>
    </div>

    <!-- Header -->
    <button class="btn btn-secondary float-right mr-3" type="button" onclick="logout()">Logout</button>
    <div class="span5 col-md-5 mb-3" id="sandbox-container" style="margin: 0 auto;">
      <h3>Delete Consult Transfer Recordings</h3>
      <div>This tool runs an analytics query to find calls with external consult transfers that were recorded and allows you to delete the last recording (which includes the conversation between the caller and the destination the call was transferred to) for this call.</div>
    </div>

    <!-- Messages -->
    <div>
      <div class="alert alert-info mb-3 mt-3" role="alert">
        The following permissions are required: <strong>Recordings > All Permissions</strong> and <strong>Analytics > All Permissions</strong><br>
        Recordings will not show as deleted immediately. This will take a few minutes.
      </div>
      <div class="alert alert-warning mb-3 mt-3" role="alert">
        WARNING: Once recordings are deleted, they can not be recovered. <strong>Make sure you know what you are doing!</strong>
      </div>
    </div>

    <!-- Date Selection & Search Button -->
    <div class="span5 col-md-5" id="sandbox-container" style="margin: 0 auto;">
      <div class="mb-3">
        <div class="row">
          <h6>#1 Select a Date range:</h6>
          <div class="input-daterange input-group mb-1" id="datepicker">
            <span class="input-group-addon ml-2 mr-2">from</span>
            <input type="text" class="input-sm form-control" name="start" id="start">
            <span class="input-group-addon ml-2 mr-2">to</span>
            <input type="text" class="input-sm form-control" name="end" id="end">
          </div>
        </div>
        <small>Last 14 days by default. Do not exceed 31 days.</small><br>
      </div>
      <div class="row mb-3">
        <h6>#2 (Optional) Filter calls with this phone number:</h6>
        <input type="text" class="form-control" name="externalPhoneNumber" id="externalPhoneNumber">
      </div>
      <div class="mb-3">
        <button class="btn btn-primary" type="button" onclick="start()" id="search">
          <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true" id="spinner" hidden></span>
          Search
        </button>
        <div id="message"></div>
      </div>
    </div>

    <!-- Recordings Table -->
    <table class="table table-hover">
      <thead>
        <tr>
          <th scope="col">Start Time</th>
          <th scope="col">Conversation w/ Consult Transfer</th>
          <th scope="col">Recordings</th>
          <th scope="col">Last Recording</th>
        </tr>
      </thead>
      <tbody id="conversationsTable">
      </tbody>
    </table>

  </div>

  <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
  <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
  <script src="./assets/dist/js/bootstrap-datepicker.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ho+j7jyWK8fNQe+A12Hb8AhRq26LrZ/JpcUGGOn+Y7RsweNrtN/tE3MoK7ZeZDyx" crossorigin="anonymous"></script>

  <script type="text/javascript">
    let results = {};
    let divisions = [];

    let token = localStorage.getItem('access_token');
    let environment = localStorage.getItem('environment');

    $('.toast').toast({
      delay: 10000
    });

    //#region Date Range Selection

    Date.prototype.addDays = function (days) {
      var date = new Date(this.valueOf());
      date.setDate(date.getDate() + days);
      return date;
    }

    $('#sandbox-container .input-daterange').datepicker({
      format: "yyyy-mm-ddT00:00:00Z",
      todayBtn: "linked",
      autoclose: true,
      todayHighlight: true
    });

    $("#start").val(new Date().addDays(-14).toISOString())
    $("#end").val(new Date().toISOString())

    //#endregion 

    async function start() {
      try {
        showStatus('Initializing...');

        $("#search").attr('disabled', true);
        $("#spinner").attr('hidden', false);

        if ($("#start").val() === '' || $("#end").val() === '') {
          alert("Please set the start and end dates first");
          return;
        }

        console.log('start()');
        $("#conversationsTable").empty();

        // Get list of conversations with consult transfers to external parties
        showStatus('Getting Conversations with a completed external consult transfer...');
        await runAnalyticsQuery($("#externalPhoneNumber").val());

        // Get recordings ids
        showStatus('Getting Recordings...');
        await getRecordingIds();

        // Populate table
        await populateTable();
      } catch (err) {
        console.error(err);
      } finally {
        showStatus('');
        $("#search").attr('disabled', false);
        $("#spinner").attr('hidden', true);
      }
    }

    function runAnalyticsQuery(phoneNumber) {
      return new Promise(async (resolve, reject) => {
        try {
          let body = {
            "interval": `${$("#start").val()}/${$("#end").val()}`,
            "order": "asc",
            "orderBy": "conversationStart",
            "paging": {
              "pageSize": 100,
              "pageNumber": 1
            },
            "segmentFilters": [
              {
                "type": "and",
                "predicates": [
                  {
                    "type": "dimension",
                    "dimension": "direction",
                    "operator": "matches",
                    "value": "outbound"
                  }
                ]
              }
            ],
            "conversationFilters": [
              {
                "type": "and",
                "predicates": [
                  {
                    "type": "metric",
                    "metric": "nConsultTransferred",
                    "range": {
                      "gte": 1
                    }
                  }
                ]
              }
            ]
          };

          if (phoneNumber) {
            body.segmentFilters[0].predicates.push({
              "type": "dimension",
              "dimension": "ani",
              "operator": "matches",
              "value": phoneNumber
            })
          }

          console.log('Running analytics query:', body);
          let data = await callAPI('POST', 'analytics/conversations/details/query', body);
          results.analyticsQueryResults = data;
          return resolve();
        } catch (error) {
          return reject(error)
        }
      });
    }

    function getRecordingIds() {
      return new Promise(async (resolve, reject) => {
        try {
          if (!results.analyticsQueryResults || !results.analyticsQueryResults.conversations) {
            alert('No conversations found');
            return reject('No conversations found');
          }
          for await (const conversation of results.analyticsQueryResults.conversations) {
            try {
              let data = await callAPI('GET', `conversations/${conversation.conversationId}/recordings?maxWaitMs=5000&formatId=WEBM`);
              console.debug(data);
              conversation.recordings = data;
            } catch (error) {
              if (error.status === 404) {
                console.debug('No recordings found for: ', conversation.conversationTd)
                continue;
              }
            }
          }
          return resolve();
        } catch (error) {
          return reject(error);
        }
      });
    }

    async function populateTable() {
      if (!results?.analyticsQueryResults?.conversations) {
        console.error('No results found');
        return;
      }

      console.log('Results:', results);
      for await (const conversation of results.analyticsQueryResults.conversations) {
        if (conversation.recordings && conversation.recordings.length > 1) {
          let conversationRow = $("<tr/>").appendTo("#conversationsTable");

          // Start Time
          $("<td/>").text(conversation.conversationStart).appendTo(conversationRow)

          // Conversation - Id
          let conversationTd = $("<td/>").appendTo(conversationRow);
          let conversationDiv = $("<div/>").appendTo(conversationTd);
          $("<div/>").html(`<a href="https://apps.${environment}/directory/#/engage/admin/interactions/${conversation.conversationId}" target="_blank">${conversation.conversationId}</a>`).appendTo(conversationDiv);

          // Conversation - Division
          let conversationDivisionDiv = $("<div/>").appendTo(conversationDiv);
          for (let index = 0; index < conversation.divisionIds.length; index++) {
            const conversationDivisionId = conversation.divisionIds[index];

            // Cache division name to avoid calling the API every time
            let divisionName;
            let existingDivision = divisions.find(d => d.id === conversationDivisionId);
            if (existingDivision && existingDivision.length > 0) {
              divisionName = existingDivision.name;
            } else {
              let data = await callAPI('GET', `authorization/divisions/${conversationDivisionId}`);
              divisionName = data.name;
              divisions.push({
                id: conversationDivisionId,
                name: data.name
              });
            }
            $("<small/>").text(`Division: ${divisionName}`).appendTo(conversationDivisionDiv);
          }

          // Conversation - External Phone Number
          let conversationExternalPhoneNumberDiv = $("<div/>").appendTo(conversationDiv);

          for (let index = 0; index < conversation.participants.length; index++) {
            const conversationParticipant = conversation.participants[index];
            if ((conversationParticipant.purpose === 'customer' || conversationParticipant.purpose === 'external') && conversationParticipant.externalContactId) {
              let externalPhoneNumber = conversationParticipant.sessions.find(s => s.mediaType === 'voice').ani;
              $("<small/>").text(`Exernal Phone Number: ${externalPhoneNumber}`).appendTo(conversationExternalPhoneNumberDiv);
              $("<br/>").appendTo(conversationExternalPhoneNumberDiv);
            }

          }

          // Recordings
          let recordingsTd = $("<td />", {}).appendTo(conversationRow);
          let lastRecording;
          for await (const recording of conversation.recordings) {
            let recordingDiv = $("<div/>").appendTo(recordingsTd);
            $("<div/>").text(recording.id).appendTo(recordingDiv);
            let recordingStartTimeDiv = $("<div/>").appendTo(recordingDiv);
            $("<small/>").text(`Start Time: ${recording.startTime}`).appendTo(recordingStartTimeDiv);

            lastRecording = {
              conversationId: conversation.conversationId,
              recordingId: recording.id,
              fileState: recording.fileState
            };
          }

          // Last Recording
          let lastRecordingTd = $("<td />", {}).appendTo(conversationRow);

          let lastRecordingDiv = $("<div/>").appendTo(lastRecordingTd);
          let buttonClass = lastRecording.fileState !== "AVAILABLE" ? "btn-success" : "btn-danger";
          let buttonText = lastRecording.fileState !== "AVAILABLE" ? `Status: ${lastRecording.fileState}` : "Delete Last Recording";
          let buttonDisabled = lastRecording.fileState !== "AVAILABLE";
          $("<button/>", { class: `btn ml-3 ${buttonClass}`, disabled: buttonDisabled }).text(buttonText).on('click', (e) => deleteRecording(lastRecording.conversationId, lastRecording.recordingId)).appendTo(lastRecordingDiv);

          let lastRecordingRecordingId = $("<div/>").appendTo(lastRecordingDiv);
          $("<small/>", {}).text(` (${lastRecording.recordingId})`).appendTo(lastRecordingRecordingId);

        }
      }

    }

    function deleteRecording(conversationId, recordingId) {
      return new Promise(async (resolve, reject) => {
        try {
          let body = {
            fileState: "DELETED",
            deleteDate: new Date().addDays(-1).toISOString()
          };

          console.log('Setting recording deleteDate to:', body.deleteDate);
          let data = await callAPI('PUT', `conversations/${conversationId}/recordings/${recordingId}`, body);
          console.log('Recording set for deletion');
          $('.toast').toast('show');
          return resolve();
        } catch (error) {
          return reject(error);
        }
      });
    }

    async function logout() {
      await callAPI('DELETE', 'tokens/me');
      localStorage.clear('access_token');
      localStorage.clear('environment');
      window.location.href = 'index.html';
    }

    //#region Misc
    function showStatus(message) {
      $("#message").text(message);
    }

    function callAPI(method, apiPath, body) {
      console.debug('Calling:', apiPath);

      return new Promise(async (resolve, reject) => {
        try {
          await axios({
            url: `https://api.${environment}/api/v2/${apiPath}`,
            method: method,
            headers: {
              Authorization: `bearer ${token}`,
              'Content-Type': 'application/json',
            },
            data: body
          })
            .then((response) => {
              if (response.status === 202) {
                // Need to wait until ready (200)
              }
              console.debug('Axios request succeeded:', response);
              return resolve(response.data);
            })
            .catch((error) => {
              return reject(error);
            })
            .finally(() => {
              console.debug('Axios request complete.');
            });
        } catch (error) {
          console.error(error);
          return reject(error);
        } finally {
          console.debug('Request complete.');
        }
      });
    }

    axios.interceptors.response.use(async (response) => {
      console.debug('Response:', response);
      if (response.status === 202) {
        console.log('Recording is not ready yet. Retrying...');
        await sleep(1000);
        return axios.request(response.config);
      }
      return response;
    }, (error) => {
      return Promise.reject(error);
    });

    function sleep(ms) {
      console.log(`Waiting ${ms} ms...`);
      return new Promise((resolve) => setTimeout(resolve, ms));
    }

    //#endregion

  </script>
</body>

</html>